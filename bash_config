#!/bin/bash

#############
# MISC SETUP
#############

export PATH="\
/usr/local/bin:\
/usr/local/sbin:\
/usr/bin:\
/bin:\
/usr/sbin:\
/sbin:\
~/global_npm/bin:\
$CJB_BIN/scripts:\
"

export EDITOR="vim"

# lots of history, and append it to histfile instead of overwriting
export HISTSIZE=100000
shopt -s histappend

# enable color in 'ls' output, even when piping to 'less'
export CLICOLOR=1
export CLICOLOR_FORCE=1

eval "$(rbenv init -)"


###################
# RANDOM FUNCTIONS
###################

git_current_branch() {
  git rev-parse --abbrev-ref HEAD 2>&1 |
  grep -v "^fatal"
}

git_remote_name() {
  git remote | head -n 1
}

git_merge_current_remote_branch() {
  git merge $(git_remote_name)/$(git_current_branch)
}

git_fetch_remote() {
  git fetch $(git_remote_name)
}

forward_port() {
  if [ -z "$1" ]; then
    echo "Usage: forward_port <USERNAME> <HOSTNAME> <PORT>"
  else
    ssh $1@$2 -L $3:$2:$3 -N
  fi
}

toggle_hidden_files_in_finder() {
  if [ `defaults read com.apple.finder AppleShowAllFiles` == "TRUE" ]; then
    defaults write com.apple.finder AppleShowAllFiles FALSE
  else
    defaults write com.apple.finder AppleShowAllFiles TRUE
  fi
  killall Finder
}


##########
# ALIASES
##########

# git aliases
alias g="git status"
alias gfg="git_fetch_remote"
alias gitc="git diff --cached"

# open this project on github
alias gho="github_open.sh"

# merge github version of this branch with local
alias gm="git_merge_current_remote_branch"

# spelling is hard
alias gtci="gitc"
alias gtic="gitc"

# grep stuff
alias grep="grep --color=auto -E --exclude=tags"
alias jsgrep='find . -type f -and \( -name "*.coffee" -or -name "*.js" -or -name "*.hbs" \) -and -not \( -path "*node_modules*" -or -path "*bower_components*" -or -path "*tmp*" -or -path "*dist*" \) -print0 | xargs -0 grep'
alias pygrep='find . -type f -and -name "*.py" -and -not -path "*migrations*" -print0 | xargs -0 grep'
alias htmlgrep='find . -type f -and -name "*.html" -print0 | xargs -0 grep'
alias cgrep='find . -type f -and -name "*.c" -or -name "*.h" -print0 | xargs -0 grep'

# ls better
alias ls="ls -FGC"
alias l="ls -lh"
alias ll="l | less -R"
alias la="l -a"
alias lal="la | less -R"

# random helpers
alias be="bundle exec"
alias die_pyc="find . -name '*.pyc' -delete ; find . -type d -name '__pycache__' -delete"
alias j="jobs"
alias json="pbpaste | python -m json.tool"
alias ne="\$(npm bin)"
alias p="pbcopy"
alias psh="pushd ~"
alias ql="qlmanage -p" # OSX Finder's "quick look" preview thing
alias scr="screen -r"
alias tmux="tmux attach || tmux"
alias types="find . -type f -exec basename {} \; | rev | cut -d '.' -f 1 | rev | sort | uniq" # list all filetypes in this and child directories
alias vi="mvim -v"
alias vim="mvim -v"
alias vv=". venv/bin/activate"
alias x="xargs"


#########
# PROMPT
#########

number_of_running_jobs() {
  NUM=`jobs | wc -l | awk '{print $1}'`
  if [ "$NUM" != "0" ] ; then
    echo "[$NUM]"
  fi
}

warn_if_i_have_uncleared_scratch_notes() {
  if [ -s ~/Dropbox/scratch_notes.md ] ; then
    echo "!!"
  fi
}

now() {
  date "+%H:%M"
}

NO_COLOR='\e[0m'
YELLOW='\e[1;33m'
BLUE='\e[1;34m'
CYAN='\e[1;36m'
PS1="\n\$(now) $YELLOW\$(warn_if_i_have_uncleared_scratch_notes)$BLUE\h $CYAN\u $NO_COLOR\w $YELLOW \$(git_current_branch) $BLUE \$(number_of_running_jobs) $NO_COLOR \n$ "


#################
# OTHER INCLUDES
#################

source $CJB_BIN/scripts/git-completion.bash
source $CJB_BIN/local_bash_config
